"""
Unit tests for malware analysis API
"""

import pytest
from fastapi.testclient import TestClient
from api.main import app
import io

client = TestClient(app)


def test_malware_scan_pe_file():
    """Test malware scan with PE file"""
    # Create fake PE file
    fake_pe = b'MZ' + b'\x00' * 1000
    
    response = client.post(
        "/scan/malware",
        files={"file": ("test.exe", io.BytesIO(fake_pe), "application/octet-stream")}
    )
    
    assert response.status_code == 200
    data = response.json()
    
    assert "scan_id" in data
    assert "family" in data
    assert "confidence" in data
    assert data["file_type"] == "PE"
    assert 0 <= data["confidence"] <= 1


def test_malware_scan_elf_file():
    """Test malware scan with ELF file"""
    # Create fake ELF file
    fake_elf = b'\x7fELF' + b'\x00' * 1000
    
    response = client.post(
        "/scan/malware",
        files={"file": ("test.bin", io.BytesIO(fake_elf), "application/octet-stream")}
    )
    
    assert response.status_code == 200
    data = response.json()
    
    assert data["file_type"] == "ELF"


def test_malware_scan_invalid_file():
    """Test malware scan with invalid file type"""
    # Create non-PE/ELF file
    fake_file = b'INVALID' + b'\x00' * 1000
    
    response = client.post(
        "/scan/malware",
        files={"file": ("test.txt", io.BytesIO(fake_file), "application/octet-stream")}
    )
    
    assert response.status_code == 400


def test_malware_scan_empty_file():
    """Test malware scan with empty file"""
    response = client.post(
        "/scan/malware",
        files={"file": ("test.exe", io.BytesIO(b''), "application/octet-stream")}
    )
    
    assert response.status_code == 400


def test_query_by_hash():
    """Test query malware by hash"""
    test_hash = "a" * 64  # Fake SHA-256
    
    response = client.get(f"/scan/malware/hash/{test_hash}")
    
    assert response.status_code == 200
    data = response.json()
    assert "sha256" in data


def test_list_malware_families():
    """Test list all malware families"""
    response = client.get("/scan/malware/families")
    
    assert response.status_code == 200
    data = response.json()
    
    assert "families" in data
    assert "total" in data
    assert len(data["families"]) > 0


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
